# Network Monitor Auto-Responder Script - AI Instructions

## Project Overview

This project implements a Python Auto-Responder script for MeshMonitor that monitors router and DNS health, outputs JSON alerts only when notifications should fire, with configurable checks, failure streak tracking, and alert backoff logic.

## Core Requirements

### MeshMonitor Compatibility
- Script must be executable (`chmod +x`)
- Output JSON to stdout with `response` or `responses` field
- Complete within 10 seconds (hard limit)
- Include `mm_meta` block at top of script:
  ```python
  #!/usr/bin/env python3
  # mm_meta:
  #   name: Network Monitor
  #   emoji: ðŸŒ
  #   language: Python
  ```

### Code Standards
- **Language**: Python 3.5+ (standard library preferred, minimal dependencies)
- **Dependencies**: Prefer standard library (`urllib`, `subprocess`, `json`, `ssl`, `time`, `concurrent.futures`)
- **Type Hints**: Use Python 3.5+ compatible type hints
- **Documentation**: All functions must have docstrings
- **Error Handling**: Graceful handling of network errors, timeouts, and file I/O

### File Structure
- `memon.py` - Main script
- `memon.config.json` - Configuration file
- `memon.state.json` - State file (auto-created, not in repo)
- `memon.test.py` - Test suite using `unittest`
- `README.md` - Comprehensive documentation

### Key Functions (from plan)
- `load_config()` - Load and validate config with defaults
- `load_state()` - Load state file or create default
- `save_state()` - Write state to JSON file
- `check_router()` - Perform router check (HTTPS or PING)
- `check_dns()` - Check single DNS resolver using subprocess
- `check_all_dns()` - Check all DNS resolvers in parallel (with timeout)
- `classify_status()` - Determine status classification
- `should_fire_down_alert()` - Check if DOWN alert should fire
- `should_fire_up_alert()` - Check if UP alert should fire
- `emit_alert()` - Output JSON to stdout
- `main()` - Orchestrate checks and alert logic with timeout protection

### Alert Logic
- **DOWN alert fires when**: `failStreak >= mustFailCount` AND `downNotified == false` AND backoff elapsed
- **UP alert fires when**: All checks pass AND `downNotified == true`
- Only emit JSON to stdout when alert fires, otherwise exit silently

### Testing Requirements
- All functions must be tested
- Mock external dependencies (`urllib.request`, `subprocess`, `json`, `os.path`)
- Test router checks (HTTPS success/failure, PING success/failure)
- Test DNS checks (all pass, all fail, partial failure)
- Test failure streak logic (mustFailCount threshold)
- Test backoff logic (time-based suppression)
- Test recovery logic (UP after DOWN)
- Test placeholder replacement in messages
- Test state file creation and updates
- Test clock skew protection
- Test timeout protection (ensure < 10s total)
- Verify no stdout output when no alert fires

### Configuration Schema
- `timeoutMs`: Timeout per check in milliseconds
- `mustFailCount`: Consecutive failures before alerting
- `alertBackoffSeconds`: Minimum time between alerts
- `messages`: Alert message templates (routerDown, ispDown, upstreamDnsDown, recovery)
- `routerCheck`: Router check config (type: https|ping, url, insecureTls, host, pingCount)
- `dnsChecks`: Array of DNS check configs (name, server, qname, rrtype)

### Error Handling
- Config file missing/invalid â†’ exit with error (stderr only, no stdout)
- State file missing â†’ create default state
- Network timeouts â†’ respect `timeoutMs` per check, ensure total < 10s
- Clock skew â†’ clamp `lastAlertTs` if in future
- DNS/HTTPS errors â†’ treat as failures, continue checking
- Subprocess errors â†’ handle gracefully, treat as DNS failure

## Development Guidelines

### When Making Changes
1. **Always run tests** when making code changes: `python -m unittest memon.test` or `make test`
   - Tests also run automatically via pre-commit hooks (if installed) and GitHub Actions on push/PR
   - Run tests locally before committing to catch issues early
2. **Maintain test coverage** - add tests for new functionality
3. **Respect MeshMonitor timeout** - ensure total execution < 10 seconds
4. **Update documentation** if configuration or behavior changes
5. **Follow existing code style** - consistent with current implementation

### Code Review Checklist
- [ ] All tests pass
- [ ] No new dependencies added (or minimal, well-justified)
- [ ] Timeout protection maintained (< 10s total)
- [ ] Error handling is graceful
- [ ] Documentation updated if needed
- [ ] Type hints included for new functions
- [ ] Docstrings added for new functions

### Testing Strategy
- Use `unittest.mock` to mock external dependencies
- Test both success and failure paths
- Test edge cases (empty configs, missing files, timeouts)
- Verify JSON output format matches MeshMonitor requirements
- Test state persistence across runs

### Git/GitHub Workflow
- **Commit Guidelines**: 
  - Always run tests before committing: `make test` or `python -m unittest memon.test`
  - Write clear, descriptive commit messages
  - Commit related changes together (logical units)
  - Do not commit generated files (see `.gitignore`)
- **What to Commit**:
  - Source code changes (`memon.py`, `memon.test.py`)
  - Configuration templates (`memon.config.json`)
  - Documentation updates (`README.md`)
  - Build/CI configuration (`.github/`, `Makefile`, `.pre-commit-config.yaml`)
  - AI instructions (`.cursorrules`)
- **What NOT to Commit**:
  - State files (`memon.state.json` - auto-generated, runtime-specific)
  - Python cache files (`__pycache__/`, `*.pyc`)
  - IDE/editor configuration files
  - Virtual environments
- **GitHub Integration**:
  - GitHub Actions automatically runs tests on push/PR (see `.github/workflows/test.yml`)
  - Pre-commit hooks run tests locally before commits (if installed)
  - Main branch should always have passing tests
- **Branch Strategy**: Use feature branches for significant changes, merge to main after tests pass

## Deployment Notes
- Scripts should be copied to `/data/scripts/` in MeshMonitor
- Must be executable: `chmod +x /data/scripts/memon.py`
- Config file should be in same directory or path adjusted in script
- State file is auto-created and managed by script

## References
- MeshMonitor User Scripts: https://meshmonitor.org/user-scripts.html
- Plan file: `c:\Users\seron\.cursor\plans\network_monitor_auto-responder_script_af883285.plan.md`
